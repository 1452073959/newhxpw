{extend name="index_layout"/}
{block name="main"}
<link rel="stylesheet" href="/static/admin/css/diolog_add_order1.css">
</div>
<!-- 弹窗 -->
<style>
    #diolog li{
        line-height: 3;
        cursor: pointer;
        
    }
    #diolog li:hover{
        border: 1px solid #ccc;
    }
    #diolog .left{
        border-top: 1px solid #ccc;
    }
    #diolog .right{
        border-top: 1px solid #ccc;
    }
    #diolog .left li{
        text-align: center;
    }
    #diolog .right li{
        padding-left: 5px;
    }
    .checkli{
        color:#f36f20;
    }
    .add_project{
       /* width: 100%;
        height: 100%;*/
        cursor: pointer;
        /*display: block*/
    }
    .add_project:hover{
        color:red;
    }
    .pad_0{
        padding: 0 !important;
    }
    #project td,#project th{
        padding:5px 3px;
        text-align: center;
    }
    #seach_project th{
        text-align: center;
        padding:5px 3px;
    }
    .layui-card-body .layui-table{
        margin:0 0 5px 0;
    }
    .height26{
        height:26px;
        line-height: 26px
    }
    i{
        cursor: pointer;
    }
    .layui-table thead tr{
        background-color: #ffffff
    }
    .word{
        background-color: #eee;
        display: none;
    }
    .select_tmp{
        height:38px;
        padding: 0 10px;
    }
    .space td:nth-child(1){
        color:#f36e20;
    }
    .space td:nth-child(1) .layui-table-sort .layui-table-sort-asc{
        border-bottom-color:#f36e20;
    }
    .space td:nth-child(1) .layui-table-sort .layui-table-sort-desc{
        border-top-color: #f36e20
    }
    .space td:nth-child(3){
        color:#f36e20;
    }
    .project td:nth-child(3){
        text-align: left !important;
    }
    .add_project td:nth-child(3){
        text-align: left !important;
    }
    
    .layui-table td, .layui-table th {
        position:static;
    }
    #project_datas input{
        min-width: 60px;
    }
    .color_one{
        background: #fff7df;
    }
    .sort{
        width:20px;
        min-width:20px !important;
        text-align: center;
    }
    .layui-table-sort{
        margin-left: 0px;
    }
    #replace_space{
        height: 35px;
        line-height: 35px;
    }
    .myskin .layui-layer-content {
        overflow: visible;
        overflow-x: visible;
        overflow-y: visible;
    }
    .text_left{
        text-align: left !important;
    }
    .ulall li{
        float:left;border: 1px solid #ccc;
        padding: 3px 5px;
        margin-right: 5px;
        font-size: 12px;
        height: 22px;
        line-height: 22px !important;
        margin-top: 10px;
    }
    .hide_td{
        display: none;
    }
    .news_search .layui-btn{
        margin-top: 10px;
    }
    .news_search{
        padding: 0 0 10px 10px;
        white-space:nowrap;
        width: 100%;
        overflow-y: hidden;
        overflow-x: auto;
    }
    .gg{
        display: block;
        float: right;
        margin: 0 10px;
    }
    .gg i{
        font-style: normal;
    }
    #space_ul{
        overflow-y: auto;
        height:calc(100% - 56px);
    }
    .kj_div{
        height: 30px;
        width: 100%;
        line-height: 30px;
    }
    .kj_div #add_space{
        display: block;
        float: left;
        margin: 1px;
        width: 18px;
    }
    .kj_div #sel{
        float: left;
        margin: 1px;
        height: 28px;
        width: calc(100% - 22px);
    }
    .left_title{
        height: 26px;
        line-height: 26px;
        text-align: center;
    }
    .scroll::-webkit-scrollbar{
      width:10px;
      height:10px;
    }
    .scroll::-webkit-scrollbar-thumb{
      background: #ccc;
      border-radius:10px;
    }
</style>
    {include file="../application/admin/view/offerlist/diolog_add_order1.html" /}
    
    <div class="layui-card" style="height:97%;width:100%;position:fixed;background-color:#fffff;border: 1px solid #cec9c9 " id="diolog">
        <blockquote class="layui-elem-quote news_search" style="">
            <!-- {if(isset($order_info))}
                <input type="hidden" name="oid" value="{$order_info['id']}" />
            {/if} -->
            <div class="layui-inline" style="width: 95%">
               <ul class="ulall">
                  <li>客户姓名：{$customer_info.customer_name}</li>
                  <li>地址：{$customer_info.address}</li>
                  <li>电话：{$customer_info.phone}</li>
                  <li>面积：{$customer_info.area}</li>
                  <li>报价师：{$customer_info.quoter_name}</li>
                  <li>设计师：{$customer_info.designer_name}</li>
               </ul>
                <a class="layui-btn layui-btn-sm layui-btn-warm"  href="javascript:;" id="import_tmp">导入模板</a>
                <a class="layui-btn layui-btn-sm layui-btn-primary"  href="javascript:;" id="showlayer">设置费率</a>
                <a class="layui-btn layui-btn-sm layui-btn-primary"  href="javascript:;" id="set_gift">赠送礼品</a>
                <a class="layui-btn layui-btn-sm layui-btn-primary"  href="javascript:;" id="set_o_remark">修改备注</a>
                {if(isset($order_info))}
                    <input type="hidden" name="oid" value="{$order_info['id']}" />
                {/if}
            </div>     

        </blockquote>



        <div class="left" style="float: left;width: 7%;height: 92% ;overflow:auto;border-right: 1px solid #eee">
            <div class="left_title">选择空间</div>
            <div class="kj_div">
                <i id="add_space" class="layui-icon layui-icon-add-1"></i>
                <input type="text" class="layui-input height26" id="sel">
            </div>
            <ul id="space_ul" class="scroll">
                
                <!-- 空间 -->
                <?php $i = 1; ?>
                <?php foreach($offer_type[2] as $k=>$v){ ?>
                    <li {$i==1?'class="checkli"':''} data-val="{$v['name']}">{$v['name']}</li>
                    <?php $i++;?>
                <?php } ?>
            </ul>
        </div>
        <div class="right" style="float: left;width: 8%;height: calc(92%);border-right: 1px solid #eee">
            <div class="left_title">选择工种</div>
            <ul style="height: calc(100% - 26px);overflow:auto;" class="scroll">
                <li data-val="0">所有工种</li>
                <!-- 工种 -->
                <?php $i = 2; ?>
                <?php foreach($offer_type[1] as $k=>$v){ ?>
                    <li {$i==1?'class="checkli"':''} data-val="{$v['name']}">{$v['name']}</li>
                    <?php $i++;?>
                <?php } ?>
                
            </ul>
        </div>


        <div class="layui-card-body scroll" id="seach_project_div" style="width: 22%;float: left;text-align: center;border-right: 1px solid #eee;padding:0;overflow:auto;height:92%">
            <table class="layui-table" id="seach_project" >
                <colgroup>
                    <col width="40">
                    <col width="80">
                    <col>
                </colgroup>
                <thead>
                    <tr>
                        <th class="pad_0"></th>
                        <th>编号</th>
                        <th>项目名称</th>
                    </tr> 
                    <tr>
                        <th class="pad_0"><a href="javascript:;" id="clear_search" title="清空筛选"><i class="layui-icon layui-icon-delete"></i></a></th>
                        <th><input type="text" class="layui-input height26" id="select_item_number"></th>
                        <th><input type="text" class="layui-input height26" id="select_project"></th>
                    </tr> 
                </thead>
                <tbody id="seach_datas">

                </tbody>
            </table>
        </div>


        <div class="layui-card-body scroll" id="datasform_div" style="width: 61%;float: left;text-align: center;border-right: 1px solid #eee;padding:0;overflow:auto;height:calc(92% - 36px)">
            <form id="datasform" action="/admin/offerlist/add_order_operation" method="post">
                <input type="hidden" name="customerid" value="{$customer_info['id']}" >
                <input type="hidden" name="framename" value="" >
                <input type="hidden" name="remark" value="" >
                <table class="layui-table" id="project">
                    <colgroup>
                        <col width="10">
                        <col width="10">
                        <col width="100">
                        <col width="30">
                        <col width="30">
                        <col width="30">
                        <col width="50">
                        <col width="30">
                        <col width="50">
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th><i class="layui-icon layui-icon-delete" id="clear_all"></i><input type="text" id="movenum" style="width:20px;height:20px;text-align: center" title="每次移动格数" value="1" /></th>
                            <th>编号</th>
                            <th>项目名称</th>
                            <th>工程量</th>
                            <th>单位</th>
                            <th>辅材单价</th>
                            <th>辅材合价</th>
                            <th>人工单价</th>
                            <th>人工合价</th>
                        </tr> 
                    </thead>
                    <tbody id="project_datas">

                        {notempty name="data"}
                            <?php $k1 = '所有工种'; ?>
                            <tr class="word" data-word="{$k1}" data-inword="{$k1}">
                                <td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td><td colspan="4" style="text-align: left;padding-left:10px">{$k1}</td>
                                <td colspan="1"></td><td class="word_material_total" colspan="1"></td><td colspan="1"></td><td class="word_artificial_total" colspan="1"></td>
                            </tr>
                                <?php $k1 = '所有工种'; ?>
                                <?php foreach($data as $k2=>$v2){ ?>
                                    <tr class="space" data-space="{$k1}-{$k2}" data-inword="{$k1}" data-inspace="{$k2}">
                                        <td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td><td></td><td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">{$k2}</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>
                                        <td colspan="1"></td><td class="space_material_total" colspan="1"></td><td colspan="1"></td><td class="space_artificial_total" colspan="1"></td>
                                    </tr>

                                    <?php foreach($v2 as $k3=>$v3){ ?>
                                        <tr class="project" data-inword="{$k1}" data-inspace="{$k2}">
                                            {if($order_project[$k3]['type_of_work'] == '非标报价')}
                                                <input type="hidden" class="name" name="no_standard[{$k2}][{$k3}][name]" value="{$order_project[$k3]['project']}" />
                                                <input type="hidden" class="unit" name="no_standard[{$k2}][{$k3}][unit]" value="{$order_project[$k3]['company']}" />
                                                <input type="hidden" class="mprice" name="no_standard[{$k2}][{$k3}][mprice]" value="{$order_project[$k3]['quota']}" />
                                                <input type="hidden" class="aprice" name="no_standard[{$k2}][{$k3}][aprice]" value="{$order_project[$k3]['craft_show']}" />
                                                <input type="hidden" class="content" name="no_standard[{$k2}][{$k3}][content]" value="{$order_project[$k3]['material']}" />
                                            {/if}
                                            <td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>
                                            <td>{if($order_project[$k3]['type_of_work'] == '非标报价')}<span style="color:red">非标</span>{else/}{$k3}{/if}</td>
                                            <td class="text_left">{$order_project[$k3]['project']}</td>
                                            <td><input type="text" class="layui-input height26" value="{$v3 ?: 0}" data-project="{$k2}-{$k3}" name="data[{$k2}][{$k3}]"></td>
                                            <td>{$order_project[$k3]['company']}</td>
                                            <td>{$order_project[$k3]['quota']}</td>
                                            <td></td>
                                            <td>{$order_project[$k3]['craft_show']}</td>
                                            <td></td>
                                        </tr>
                                    <?php } ?>
                                <?php } ?>
                        {/notempty}
                    </tbody>
                </table>
            </form>
        </div>
        <div class="layui-card-body" id="datasform_div" style="width: 61%;float: left;text-align: right;padding:0;height:36px;line-height:36px;border-right: 1px solid #eee;border-top: 1px solid #eee;border-bottom: 1px solid #eee;line-height: 36px;">
            <a class="layui-btn layui-btn-sm layui-btn-danger" style="float: right;margin-top:3px;margin-right: 10px;" href="javascript:;" id="submit_datas">提交报价</a>
            <a class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;margin-top:3px;margin-right: 10px;" href="javascript:;" id="submit_preview">预览</a>
            <a class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;margin-top:3px;" href="javascript:;" id="cache_order">保存</a>
            <span class="gg" id="g3">工程报价：<i>{$order_info['info']['discount_proquant'] ?: 0}</i></span>
            <span class="gg" id="g2">工程管理费用：<i>{$order_info['info']['order_cost_all_price'] ?: 0}</i></span>
            <span class="gg" id="g1">工程款：<i>0</i></span>
        </div>
    </div>
<form style="display:inline-block;" id="addone"></form>
{/block}

{block name="script"}
<script src="/static/admin/js/jquery.min.js"></script>
<script src="/static/admin/js/diolog_add_order1.js"></script>
<script type="text/javascript">

    $('#cache_order').click(function(){
        var project = $('#project .project input').serializeArray();
        var datas = {};  
        $.each(project, function() {  
            if (datas[this.name]) {  
                if (!datas[this.name].push) {  
                    datas[this.name] = [ datas[this.name] ];  
                }  
                datas[this.name].push(this.value || '');  
            } else {  
                datas[this.name] = this.value || '';  
            }  
        });
        datas['user_id'] = $('input[name="customerid"]').val();
        $.post('/admin/offerlist/temporary_save_order',datas,function(res){
            if(res.code == '0'){
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg(res.msg);
                })
            }else if(res.code == 1){
                // console.log(res);
                layer.msg('保存成功');
            }else{
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg('临时保存订单为止错误，请联系管理员');
                })
            }
            
        })
    })
    
    // layui.use('form', function(){
    //     var form = layui.form;
    //     form.render();
    // });
    //弹框 end
    //更换空间replace_space
    $('#project_datas').on('click','.replace_space',function(){
        var old_name = $(this).parent().find('.space_name').text();
        var space = $('#space_ul').find('li');
        var html = '';
        html += '<form class="layui-form" action=""><select id="replace_space" lay-search>'
        $(space).each(function(k,v){
            if(1){
                var selected = '';
                if(old_name == $(v).attr('data-val')){
                    selected = 'selected';
                }
                html += '<option '+selected+' value="'+$(v).attr('data-val')+'">'
                html +=     $(v).attr('data-val')
                html += '</option>'
            }
        })
        html += '</select></form>'
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                content: html,
                title:'更换空间',
                btn: ['确认','取消'],
                skin:'myskin',
                yes: function(index, layero){
                    var res = 0;
                    $('.space_name').each(function(k,v){
                        if($(v).text() == $('#replace_space').val()){
                            layer.msg('空间：'+$('#replace_space').val()+'已存在');
                            res = 1;
                            return false
                        }
                    })
                    if(res){
                        return false;
                    }
                    //更换空间的tr
                    $('#project_datas').find('tr[class="space"][data-inspace="'+old_name+'"]').attr('data-space','所有工种-'+$('#replace_space').val());
                    $('#project_datas').find('tr[class="space"][data-inspace="'+old_name+'"]').find('.space_name').text($('#replace_space').val());
                    $('#project_datas').find('tr[class="space"][data-inspace="'+old_name+'"]').attr('data-inspace',$('#replace_space').val());
                    //更换项目的tr和td
                    $('#project_datas').find('tr[class="project"][data-inspace="'+old_name+'"]').each(function(k,v){
                        if($(v).find('input[class="name"]').length > 0){
                            $(v).find('input[class="name"]').attr('name',$(v).find('input[class="name"]').attr('name').replace(old_name, $('#replace_space').val()));
                            $(v).find('input[class="unit"]').attr('name',$(v).find('input[class="unit"]').attr('name').replace(old_name, $('#replace_space').val()));
                            $(v).find('input[class="mprice"]').attr('name',$(v).find('input[class="mprice"]').attr('name').replace(old_name, $('#replace_space').val()));
                            $(v).find('input[class="aprice"]').attr('name',$(v).find('input[class="aprice"]').attr('name').replace(old_name, $('#replace_space').val()));
                            $(v).find('input[class="content"]').attr('name',$(v).find('input[class="content"]').attr('name').replace(old_name, $('#replace_space').val()));
                        }
                        $(v).attr('data-inspace',$('#replace_space').val());
                        $(v).find('td').eq(3).find('input').attr('data-project',$(v).find('td').eq(3).find('input').attr('data-project').replace(old_name, $('#replace_space').val()));
                        $(v).find('td').eq(3).find('input').attr('name',$(v).find('td').eq(3).find('input').attr('name').replace(old_name, $('#replace_space').val()));
                    })
                    layer.close(index);
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                },
                success:function(){
                    layui.use('form', function(){
                        var form = layui.form;
                        form.render();
                    });
                }
            });
        }); 
    })


    //添加非标
    $('#project_datas').on('click','.no_standard',function(){
        //非标最多100条
        if($('#project .project input[type="hidden"]').length / 5 > 100){
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('非标报价不得超过100个');
                return false;
            })
            return false;
        }
        //判断
        var space = $(this).parent().parent().attr('data-inspace');
        var work_type = '所有工种';
        //生成不重复 随机值
        var math_num = new Date().getTime().toString();
        //这个估计就不会重复了
        math_num = math_num.substr(7) + Math.ceil(Math.random(4)*10000).toString();

        var html = '';
        html += '<div class="layui-form-item" style="margin:5px 0">'
        html += '  <label class="layui-form-label" style="width:70px;padding:9px 5px">项目名称：</label>'
        html += '  <div class="layui-input-block" style="margin-left:85px">'
        html += '    <input type="text" name="" id="ns_name" autocomplete="off" class="layui-input">'
        html += '  </div>'
        html += '</div>'

        html += '<div class="layui-form-item" style="margin:5px 0">'
        html += '  <label class="layui-form-label" style="width:70px;padding:9px 5px">单位：</label>'
        html += '  <div class="layui-input-block" style="margin-left:85px">'
        html += '    <input type="text" name="" id="ns_unit" autocomplete="off" class="layui-input">'
        html += '  </div>'
        html += '</div>'

        html += '<div class="layui-form-item" style="margin:5px 0">'
        html += '  <label class="layui-form-label" style="width:70px;padding:9px 5px">辅材单价：</label>'
        html += '  <div class="layui-input-block" style="margin-left:85px">'
        html += '    <input type="text" name="" id="ns_mprice" autocomplete="off" class="layui-input">'
        html += '  </div>'
        html += '</div>'

        html += '<div class="layui-form-item" style="margin:5px 0">'
        html += '  <label class="layui-form-label" style="width:70px;padding:9px 5px">人工单价：</label>'
        html += '  <div class="layui-input-block" style="margin-left:85px">'
        html += '    <input type="text" name="" id="ns_aprice" autocomplete="off" class="layui-input">'
        html += '  </div>'
        html += '</div>'

        html += '<div class="layui-form-item" style="margin:5px 0">'
        html += '  <label class="layui-form-label" style="width:70px;padding:9px 5px">工艺说明：</label>'
        html += '  <div class="layui-input-block" style="margin-left:85px">'
        html += '    <textarea id="ns_content" style="width:232px;height:100px"></textarea>'
        html += '  </div>'
        html += '</div>'
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                content: html,
                title:'添加非标项目',
                btn: ['确认','取消'],
                yes: function(index, layero){
                    var name = $.trim($('#ns_name').val());
                    var unit = $.trim($('#ns_unit').val());
                    var mprice = $.trim($('#ns_mprice').val());
                    var aprice = $.trim($('#ns_aprice').val());
                    var content = $.trim($('#ns_content').val());
                    if(name.indexOf('"') != -1 || unit.indexOf('"') != -1 || mprice.indexOf('"') != -1 || aprice.indexOf('"') != -1 || content.indexOf('"') != -1){
                        alert('输入内容请不要使用双引号');
                        return false;
                    }
                    if(parseFloat(mprice).toString() == "NaN" || parseFloat(aprice).toString() == "NaN"){
                        alert('单价格式错误');
                        return false;
                    }
                    if(!name || !unit || !content){
                        alert('项目名称或单位或工艺说明 不能为空');
                        return false;
                    }
                    var project = '';

                    project += '<tr class="project" data-inword="'+work_type+'" data-inspace="'+space+'">'
                    project += '<input type="hidden" class="name" name="no_standard['+space+']['+math_num+'][name]" value="'+name+'" />';
                    project += '<input type="hidden" class="unit" name="no_standard['+space+']['+math_num+'][unit]" value="'+unit+'" />';
                    project += '<input type="hidden" class="mprice" name="no_standard['+space+']['+math_num+'][mprice]" value="'+mprice+'" />';
                    project += '<input type="hidden" class="aprice" name="no_standard['+space+']['+math_num+'][aprice]" value="'+aprice+'" />';
                    project += '<input type="hidden" class="content" name="no_standard['+space+']['+math_num+'][content]" value="'+content+'" />';
                    project += '    <td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>'
                    project += '    <td><span style="color:red">非标</span></td>'
                    project += '    <td  class="color_one text_left">'+name+'</td>'
                    project += '    <td><input type="text" class="layui-input height26" data-project="'+space+'-'+math_num+'" name="data['+space+']['+math_num+']"></td>'
                    project += '    <td>'+unit+'</td>'
                    project += '    <td>'+mprice+'</td>'
                    project += '    <td></td>'
                    project += '    <td>'+aprice+'</td>'
                    project += '    <td></td>'
                    project += '</tr>'

                    $('tr[data-inspace="'+space+'"][data-inword="'+work_type+'"]').last().after(project);
                    var top = $('tr[data-inspace="'+space+'"][data-inword="'+work_type+'"]').last().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-300;
                    $("#datasform_div").animate({scrollTop:top},333);
                    layer.close(index);
                    set_sort();
                    save_order();
                    return false;
                    
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
       
    })

    //空间复制
    $('#project_datas').on('click','.copy',function(){
        var this_space = $(this).parent().parent().attr('data-inspace');
        var target_space =  $('#diolog .left li[class="checkli"]').text();
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
            content: '确定复制'+this_space+'的报价条目到'+target_space+'吗?',
            title:'添加空间',
            btn: ['提交', '取消'],
                yes: function(index, layero){
                    var project = $('.project[data-inspace="'+this_space+'"]');
                    var work_type = '所有工种';
                    $(project).each(function(k,v){
                        var project = $(v).clone();
                        $(project).attr('data-inspace',target_space);
                        // console.log($(project).find('input').attr('data-project'));
                        $(project).find('td input').not('.sort').attr('data-project',$(project).find('td input').not('.sort').attr('data-project').replace(this_space,target_space));
                        $(project).find('td input').not('.sort').attr('name',$(project).find('td input').not('.sort').attr('name').replace(this_space,target_space));
                        var item_number = $(project).find('td').eq(1).text();

                        if($(project).find('input[class="name"]').attr('name')){
                            if($('#project .project input[type="hidden"]').length / 5 > 100){
                                layui.use('layer', function(){
                                    var layer = layui.layer;
                                    layer.msg('非标报价不得超过100个，超过部分已自动忽略');
                                    return false;
                                })
                                return true;
                            }
                            var myreg = /\]\[(\d)+\]/gi;
                            //获取非标的编码
                            item_number = $(project).find('input[class="name"]').attr('name').match(myreg).toString().replace('][','').replace(']','');

                            $(project).find('input[class="name"]').attr('name',$(project).find('input[class="name"]').attr('name').replace(this_space,target_space));
                            $(project).find('input[class="unit"]').attr('name',$(project).find('input[class="unit"]').attr('name').replace(this_space,target_space));
                            $(project).find('input[class="mprice"]').attr('name',$(project).find('input[class="mprice"]').attr('name').replace(this_space,target_space));
                            $(project).find('input[class="aprice"]').attr('name',$(project).find('input[class="aprice"]').attr('name').replace(this_space,target_space));
                            $(project).find('input[class="content"]').attr('name',$(project).find('input[class="content"]').attr('name').replace(this_space,target_space));
                        }

                        
                        // var html = $(project).prop("outerHTML");

                        if($('input[data-project="'+target_space+'-'+item_number+'"]').length > 0){
                            return true;
                        }
                        if($('tr[data-space="'+work_type+'-'+target_space+'"]').length > 0){
                            $('tr[data-inspace="'+target_space+'"][data-inword="'+work_type+'"]').last().after(project);
                            // var top = $('tr[data-inspace="'+target_space+'"][data-inword="'+work_type+'"]').first().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-80;
                            // $("#datasform_div").animate({scrollTop:top},333);
                        }else{
                            //空间不存在 新建空间
                            var space_html = '';
                            space_html += '<tr class="space" data-space="'+work_type+'-'+target_space+'" data-inword="'+work_type+'" data-inspace="'+target_space+'">';
                            space_html += '<td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td>'
                            space_html += '<td></td>'
                            space_html += '<td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">'+target_space+'</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>'
                            space_html += '<td colspan="1"></td>';
                            space_html += '<td class="space_material_total" colspan="1"></td>';
                            space_html += '<td colspan="1"></td>';
                            space_html += '<td class="space_artificial_total" colspan="1"></td>';
                            space_html += '</tr>'
                            //判断工种是否不存 
                            if($('tr[data-word="'+work_type+'"]').length > 0){
                                // $('tr[data-inword="'+work_type+'"]').last().after(space_html);
                                $('tr[data-inword="'+work_type+'"][data-inspace="'+this_space+'"]').last().after(space_html);
                                $('tr[data-inspace="'+target_space+'"][data-inword="'+work_type+'"]').last().after(project);
                                var top = $('tr[data-inspace="'+target_space+'"][data-inword="'+work_type+'"]').first().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-300;
                                $("#datasform_div").animate({scrollTop:top},333);
                            }else{
                                //不存在 添加工种
                                var word_html = '';
                                word_html += '<tr class="word" data-word="'+work_type+'" data-inword="'+work_type+'">';
                                word_html += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                                word_html += '<td colspan="4" style="text-align: left;padding-left:10px">'+work_type+'</td>';
                                word_html += '<td colspan="1"></td>';
                                word_html += '<td class="word_material_total" colspan="1"></td>';
                                word_html += '<td colspan="1"></td>';
                                word_html += '<td class="word_artificial_total" colspan="1"></td>';
                                word_html += '</tr>';
                                $('#project_datas').append(word_html);
                                $('tr[data-word="'+work_type+'"]').after(space_html);
                                $('tr[data-space="'+work_type+'-'+target_space+'"]').after(project);
                            }
                        }
                        set_sort();
                        save_order();
                    })
                    layer.close(index);
                    
                },
                btn2: function(index, layero){
                    layer.close(index);
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
    })


    //=====================================上下移动
    $('#project_datas').on('click',".layui-edge",function(){
        var type = $(this).parent().parent().parent().attr('class');
        var num = $('#movenum').val();
        var r=/^[0-9]+$/gi;
        if(!r.test(num)){
            layui.use('layer', function(){
                layer.msg('移动格数设置有误');
            }); 
            return false;
        }
        num = num -1;
        if(type == 'word'){
            var tr = $(this).parent().parent().parent();
            var data_tr=$('tr[data-inword="'+$(tr).attr('data-inword')+'"]');
            if($(this).hasClass('layui-table-sort-asc')){
                var prev_word = $(tr).prevAll('.word').eq(0);
                if($(prev_word).length == 0){
                    layui.use('layer', function(){
                        layer.msg('已经是最低部了');
                    }); 
                    return false;
                }else{
                    $(data_tr).insertBefore($(prev_word)); //将本身插入到目标tr的前面 
                }
            }else{
                var next_word = $(tr).nextAll('.word').eq(0);
                if($(next_word).length == 0){
                    layui.use('layer', function(){
                        layer.msg('已经是最低部了');
                    }); 
                    return false;
                }else{
                    var next_project = $('.project[data-inword="'+$(next_word).attr('data-inword')+'"]').last();
                    if(next_project.length){
                        //工种内有项目 放在项目最后
                        $(data_tr).insertAfter($(next_project)); //将本身插入到目标tr的前面 
                    }else{
                        //没有项目 放在工种后
                        $(data_tr).insertAfter($(next_word)); //将本身插入到目标tr的前面 
                    }
                }
            }
        }else if(type == 'space'){
            var tr = $(this).parent().parent().parent();
            var data_tr=$('tr[data-inword="'+$(tr).attr('data-inword')+'"][data-inspace="'+$(tr).attr('data-inspace')+'"]');
            if($(this).hasClass('layui-table-sort-asc')){
                var prev_space = $(tr).prevAll('.space[data-inword="'+$(tr).attr('data-inword')+'"]').eq(num);
                if($(prev_space).length == 0){
                    layui.use('layer', function(){
                        layer.msg('超出可移动范围');
                    }); 
                    return false;
                }else{
                    $(data_tr).insertBefore($(prev_space)); //将本身插入到目标tr的前面 
                }
            }else{
                var next_space = $(tr).nextAll('.space[data-inword="'+$(tr).attr('data-inword')+'"]').eq(num);
                if($(next_space).length == 0){
                    layui.use('layer', function(){
                        layer.msg('超出可移动范围');
                    }); 
                    return false;
                }else{
                    var next_project = $('.project[data-inword="'+$(next_space).attr('data-inword')+'"][data-inspace="'+$(next_space).attr('data-inspace')+'"]').last();
                    if(next_project.length){
                        //空间内有项目 放在项目最后
                        $(data_tr).insertAfter($(next_project)); //将本身插入到目标tr的前面 
                    }else{
                        //没有项目 放在空间后
                        $(data_tr).insertAfter($(next_space)); //将本身插入到目标tr的前面 
                    }
                    
                }
            }
            var top = tr.offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop() -200;
            $("#datasform_div").animate({scrollTop:top},333);
            
        }else if(type == 'project'){
            var data_tr=$(this).parent().parent().parent();
            if($(this).hasClass('layui-table-sort-asc')){
                if($(data_tr).prevAll('.project[data-inspace="'+$(data_tr).attr('data-inspace')+'"]').eq(num).html()==null || !$(data_tr).prevAll('.project[data-inspace="'+$(data_tr).attr('data-inspace')+'"]').eq(num).hasClass('project')){
                    layui.use('layer', function(){
                        layer.msg('超出可移动范围');
                    }); 
                    return false;
                }else{
                    $(data_tr).insertBefore($(data_tr).prevAll().eq(num)); //将本身插入到目标tr的前面 
                }
                var symbol = -1*(num+1);
            }else{
                if($(data_tr).nextAll('.project[data-inspace="'+$(data_tr).attr('data-inspace')+'"]').eq(num).html()==null || !$(data_tr).nextAll().eq(num).hasClass('project')){
                    layui.use('layer', function(){
                        layer.msg('超出可移动范围');
                    }); 
                    return false;
                }else{
                    $(data_tr).insertAfter($(data_tr).nextAll().eq(num)); //将本身插入到目标tr的前面 
                }
                var symbol = 1*(num+1);
            }
            var top = $("#datasform_div").scrollTop() + ($(data_tr).next().height()+$(data_tr).height())/2*symbol;
            $("#datasform_div").animate({scrollTop:top},333);
        }else{
            layui.use('layer', function(){
                layer.msg('非法操作');
            }); 
            return false;
        }
        set_sort();
        save_order();//临时保存订单
    })


    //===================自动临时保存报价
    var step_number = 0;//操作的次数
    function save_order(){
        if(step_number < 1){ //每2步记录一次
            step_number++;
            return false;
        }
        step_number = 0;
        var project = $('#project .project input').serializeArray();
        var datas = {};  
        $.each(project, function() {  
            if (datas[this.name]) {  
                if (!datas[this.name].push) {  
                    datas[this.name] = [ datas[this.name] ];  
                }  
                datas[this.name].push(this.value || '');  
            } else {  
                datas[this.name] = this.value || '';  
            }  
        });
        datas['user_id'] = $('input[name="customerid"]').val();
        $.post('/admin/offerlist/temporary_save_order',datas,function(res){
            if(res.code == '0'){
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg(res.msg);
                })
            }else if(res.code == 1){
                console.log(res);
            }else{
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg('临时保存订单为止错误，请联系管理员');
                })
            }
            
        })
    }

    //==============添加空间
    //添加空间
    $('#add_space').click(function(){
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
            content: '<input type="text" id="add_name" placeholder="请输入空间名称" class="layui-input">',
            title:'添加空间',
            btn: ['提交', '取消'],
                yes: function(index, layero){
                    var add_name = $('#add_name').val();
                    $.post('/admin/offertype/ajax_add_word',{add_name:[add_name],type:2},function(res){
                        if(res.code === 0){
                            layer.msg(res.msg);
                        }else{
                            $('#space_ul').append('<li class="" data-val="'+add_name+'">'+add_name+'</li>');
                            layer.msg(res.msg);
                        }
                    },'json')
                },
                btn2: function(index, layero){
                    layer.close(index);
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
    })

    //======================提交订单
    $('#submit_datas').click(function(){
        // event.preventDefault();
        $(this).attr("disabled",true).css("pointer-events","none");
        setTimeout(function(e){
            $("#submit_datas").removeAttr("disabled");
            $("#submit_datas").css("pointer-events","");
        },5000)
        var is_null = 0;
        var unit = $('input[name="unit"]').val();
        var remark = $('input[name="remark"]').val();
        var o_remark = $('textarea[name="o_remark"]').val();
        var customerid = $('input[name="customerid"]').val();
        var tmp_cost_id = $('select[name="tmp_cost"]').val();
        var oid = $('input[name="oid"]').val();
        if(unit == ''){
            layui.use('layer', function(){
                layer.msg('请填写单位/公司');
            }); 
            return false;
        }
        // if(tmp_cost_id == ''){
        //     layui.use('layer', function(){
        //         layer.msg('请选择取费模板');
        //     }); 
        //     return false;
        // }
        // $('input[name="framename"]').val(unit);
        // $('input[name="remark"]').val(remark);
        if($('#project_datas input').length < 1){
            layui.use('layer', function(){
                layer.msg('请选择项目');
            }); 
            return false;
        }
        $('#project_datas input').not('.sort , .unit , .content').each(function(k,v){
            if($(v).val() == ''){
                var word = $(v).parent().parent().attr('data-inword');
                var project = $(v).attr('data-project');
                layui.use('layer', function(){
                    layer.msg(word+'-'+project+' 数量不得为空');
                }); 
                is_null = 1;
                return null;
            }
        })
        if(is_null){
            return false;
        }
        var project = $('#project .project input ,#diolog_new1_form,#gift_form').serializeArray();
        var datas = {};  
        $.each(project, function() {  
            if (datas[this.name]) {  
                if (!datas[this.name].push) {  
                    datas[this.name] = [ datas[this.name] ];  
                }  
                datas[this.name].push(this.value || '');  
            } else {  
                datas[this.name] = this.value || '';
            }  
        });  
        datas['framename'] = unit;  
        datas['remark'] = remark;  
        datas['o_remark'] = o_remark;  
        datas['customerid'] = customerid;
        if(oid){
            datas['oid'] = oid;
        }
        if(tmp_cost_id != ''){
            datas['tmp_cost_id'] = tmp_cost_id;
        }
        $.post('/admin/offerlist/add_order_operation',datas,function(res){
            if(res.code == 1){
                layui.use('layer', function(){
                    layer.msg(res.msg);
                    setTimeout(function () { 
                        window.location.href = res.url; 
                    }, 2000); 
                });

            }else{
                //失败 提醒
                layui.use('layer', function(){
                    layer.msg(res.msg);
                }); 
            }
        })
    })
    //======================提交订单end

    //======================预览订单start
    $('#submit_preview').click(function(){
        var is_null = 0;
        var unit = $('input[name="unit"]').val();
        var remark = $('input[name="remark"]').val();
        var o_remark = $('textarea[name="o_remark"]').val();
        var customerid = $('input[name="customerid"]').val();
        var tmp_cost_id = $('select[name="tmp_cost"]').val();
        var oid = $('input[name="oid"]').val();
        if(unit == ''){
            layui.use('layer', function(){
                layer.msg('请填写单位/公司');
            }); 
            return false;
        }
        if($('#project_datas input').length < 1){
            layui.use('layer', function(){
                layer.msg('请选择项目');
            }); 
            return false;
        }
        $('#project_datas input').not('.sort , .unit , .content').each(function(k,v){
            if($(v).val() == ''){
                var word = $(v).parent().parent().attr('data-inword');
                var project = $(v).attr('data-project');
                layui.use('layer', function(){
                    layer.msg(word+'-'+project+' 数量不得为空');
                }); 
                is_null = 1;
                return null;
            }
        })
        if(is_null){
            return false;
        }
        var project = $('#project .project input ,#diolog_new1_form,#gift_form').serializeArray();
        var datas = {};  
        $.each(project, function() {  
            if (datas[this.name]) {  
                if (!datas[this.name].push) {  
                    datas[this.name] = [ datas[this.name] ];  
                }  
                datas[this.name].push(this.value || '');  
            } else {  
                datas[this.name] = this.value || '';
            }  
        });  
        datas['framename'] = unit;  
        datas['remark'] = remark;  
        datas['o_remark'] = o_remark;  
        datas['customerid'] = customerid;
        if(oid){
            datas['oid'] = oid;
        }
        if(tmp_cost_id != ''){
            datas['tmp_cost_id'] = tmp_cost_id;
        }
        var form = $("<form method='post'></form>");
        form.attr({"action":'/admin/offerlist/preview_order'});
        form.attr({"target":'_blank'});
        for (arg in datas){
            if($.isArray(datas[arg])){
                for (info in datas[arg]){
                    var input = $("<input type='hidden'>");
                    input.attr({"name":arg});
                    input.val(datas[arg][info]);
                    form.append(input);
                }
            }else{
                var input = $("<input type='hidden'>");
                input.attr({"name":arg});
                input.val(datas[arg]);
                form.append(input);
            }
        }
        var formSubmit = $(form);
        $(document.body).append(formSubmit);
        form.submit();
        $(form).remove();
    })
    //======================预览订单end


    //=======================导入模板start

    $('#import_tmp').click(function(){
        layui.use('layer', function(){
            $.post('/admin/quote/ajax_get_tmp_list',{},function(res){
                if(res.code == 1){
                    var html = ''
                    html += '<div class="layui-tab">'
                    html += '   <ul class="layui-tab-title">'
                    html += '       <li class="layui-this">导入报价模板</li>'
                    html += '       <li>导入客户报价</li>'
                    html += '   </ul>'
                    html += '   <div class="layui-tab-content">'
                    html += '       <div class="layui-tab-item layui-show">'
                    html += '           <table style="text-align:center" class="layui-table"><thead>'
                    html += '              <tr>'
                    html += '                 <th style="text-align:center"></th>'
                    html += '                 <th style="text-align:center">模板名称</th>'
                    html += '                 <th style="text-align:center">备注</th>'
                    html += '                 <th style="text-align:center">修改时间</th>'
                    html += '              </tr>'
                    html += '           </thead>';
                    html += '           <tbody>';
                    $(res.datas).each(function(k,v){
                    html += '               <tr>'
                    html += '                 <td><a style="color:#fb8c4c" href="javascript:;" onclick="check_tmp(this)" data-tid="'+v.tmp_id+'">选择</a></td>'
                    html += '                 <td>'+v.tmp_name+'</td><td>'+v.remark+'</td>'
                    html += '                 <td>'+v.update_time+'</td>'
                    html += '               </tr>'
                    })
                    html+= '</tbody></table>'
                    html += '       </div>';
                    html += '       <div class="layui-tab-item">';
                    html += '           <table style="text-align:center" class="layui-table"><thead>'
                    html += '              <tr>'
                    html += '                 <th style="text-align:center"></th>'
                    html += '                 <th style="text-align:center">客户名称</th>'
                    html += '                 <th style="text-align:center">地址</th>'
                    html += '                 <th style="text-align:center">房屋类型</th>'
                    html += '                 <th style="text-align:center">面积</th>'
                    html += '                 <th style="text-align:center">设计师</th>'
                    html += '                 <th style="text-align:center">添加时间</th>'
                    html += '              </tr>'
                    html += '           </thead>';
                    html += '           <tbody>';
                    $.post('/admin/offerlist/get_userlist_order',{},function(order){
                        if(order.code == 1){
                            // $(order.data).each(function(k1,v1){
                            $.each(order.data,function(k1,v1){
                                html += '               <tr>'
                                html += '                 <td><a style="color:#fb8c4c" href="javascript:;" class="tr_operation" onclick="open_tr(this)" data-id="'+k1+'">展开</a></td>'
                                html += '                 <td>'+v1.customer_name+'</td>'
                                html += '                 <td>'+v1.address+'</td>'
                                html += '                 <td>'+v1.room_type+'</td>'
                                html += '                 <td>'+v1.area+'²</td>'
                                html += '                 <td>'+v1.designer_name+'</td>'
                                html += '                 <td>'+v1.addtime+'</td>'
                                html += '               <tr class="zk_'+k1+' order_tr" style="display:none;background-color:#eee">'
                                html += '                 <td></td>'
                                html += '                 <td>状态</td>'
                                html += '                 <td>工程报价</td>'
                                html += '                 <td>直接费</td>'
                                html += '                 <td>折扣</td>'
                                html += '                 <td>取费模板</td>'
                                html += '                 <td>录入时间</td>'
                                html += '               </tr>'
                                html += '               </tr>'
                                $.each(v1.order,function(k2,v2){
                                    html += '               <tr class="zk_'+k1+' order_tr" style="display:none">'
                                    html += '                 <td><a href="javascript:;" onclick="check_order('+v2.oid+')">选择</a></td>'
                                    html += '                 <td>'+v2.status+'</td>'
                                    html += '                 <td>'+v2.discount_proquant+'</td>'
                                    html += '                 <td>'+v2.direct_cost+'</td>'
                                    html += '                 <td>'+v2.discount+'</td>'
                                    html += '                 <td>'+v2.tmp_name+'</td>'
                                    html += '                 <td>'+v2.addtime+'</td>'
                                    html += '               </tr>'
                                })
                            })
                        }
                        html+= '</tbody></table>'
                        html += '       </div>';
                        html += '   </div>';
                        html += '</div>';
                        layer.open({
                            title: '选择模板',
                            area: ['80%', '60%'],
                            content:html,
                            success:function(){
                                layui.use('element', function(){
                                  var element = layui.element;
                                });
                            }
                        }); 
                    },'json')
                }else{
                    layer.msg(res.msg);
                }
            },'json')
        }); 
    })

    function open_tr(o){
        $('.order_tr').hide();
        $('.tr_operation').text('展开');
        $('.tr_operation').attr('onclick','open_tr(this)');

        $(o).text('关闭');
        $(o).attr('onclick','close_tr(this)');
        var id = $(o).attr('data-id');
        $('.zk_'+id).show();

    }
    function close_tr(o){
        $(o).text('展开');
        $(o).attr('onclick','open_tr(this)');
        var id = $(o).attr('data-id');
        $('.zk_'+id).hide();
    }
    
    function check_order(oid){
        $.post('/admin/offerlist/ajax_get_tmp_order',{oid:oid},function(res){
            if(res.code == 1){
                // var offerquota = res.offerquota;
                var tmp_cost_id = res.tmp_cost_id;
                if(tmp_cost_id){
                    $("select[name='tmp_cost']").find("option").attr("selected",false);
                    $("select[name='tmp_cost']").find("option[value="+tmp_cost_id+"]").attr("selected",true);
                }
                var datas = res.datas;
                var is_in = 0;
                $(res.datas).each(function(k,v){
                    if($('input[data-project="'+v.space+'-'+v.item_number+'"]').length > 0){
                        is_in = 1;
                        return true;
                    }
                    var project = '';
                    //不要工种分类
                    v.work_type = '所有工种';
                    project += '<tr class="project" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                    if(v.type_of_work == '非标报价'){
                        project +=  '<input type="hidden" class="name" name="no_standard['+v.space+']['+v.item_number+'][name]" value="'+v.project+'" />'
                        project +=  '<input type="hidden" class="unit" name="no_standard['+v.space+']['+v.item_number+'][unit]" value="'+v.company+'" />'
                        project +=  '<input type="hidden" class="mprice" name="no_standard['+v.space+']['+v.item_number+'][mprice]" value="'+v.quota+'" />'
                        project +=  '<input type="hidden" class="aprice" name="no_standard['+v.space+']['+v.item_number+'][aprice]" value="'+v.craft_show+'" />'
                        project +=  '<input type="hidden" class="content" name="no_standard['+v.space+']['+v.item_number+'][content]" value="'+v.material+'" />'
                    }
                    project += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                    if(v.type_of_work == '非标报价'){
                        project += '<td><span style="color:red">非标</span></td>'; 
                    }else{
                       project += '<td>'+v.item_number+'</td>'; 
                    }
                    project += '<td  class="text_left">'+v.project+'</td>';
                    project += '<td><input type="text" class="layui-input height26" value="'+v.num+'" data-project="'+v.space+'-'+v.item_number+'" name="data['+v.space+']['+v.item_number+']" /></td>';
                    project += '<td>'+v.company+'</td>';
                    project += '<td>'+v.quota+'</td>';
                    project += '<td></td>';
                    project += '<td>'+v.craft_show+'</td>';
                    project += '<td></td>';
                    project += '</tr>';
                    if($('tr[data-space="'+v.work_type+'-'+v.space+'"]').length > 0){
                        $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                    }else{
                        //空间不存在 新建空间
                        var space_html = '';
                        space_html += '<tr class="space" data-space="'+v.work_type+'-'+v.space+'" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                        space_html += '<td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td>'
                        space_html += '<td></td>'
                        space_html += '<td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">'+v.space+'</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>'
                        space_html += '<td colspan="1"></td>';
                        space_html += '<td class="space_material_total" colspan="1"></td>';
                        space_html += '<td colspan="1"></td>';
                        space_html += '<td class="space_artificial_total" colspan="1"></td>';
                        space_html += '</tr>'
                        //判断工种是否不存 
                        if($('tr[data-word="'+v.work_type+'"]').length > 0){
                            $('tr[data-inword="'+v.work_type+'"]').last().after(space_html);
                            $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                        }else{
                            //不存在 添加工种
                            var word_html = '';
                            word_html += '<tr class="word" data-word="'+v.work_type+'" data-inword="'+v.work_type+'">';
                            word_html += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                            word_html += '<td colspan="4" style="text-align: left;padding-left:10px">'+v.work_type+'</td>';
                            word_html += '<td colspan="1"></td>';
                            word_html += '<td class="word_material_total" colspan="1"></td>';
                            word_html += '<td colspan="1"></td>';
                            word_html += '<td class="word_artificial_total" colspan="1"></td>';
                            word_html += '</tr>';
                            $('#project_datas').append(word_html);
                            $('tr[data-word="'+v.work_type+'"]').after(space_html);
                            $('tr[data-space="'+v.work_type+'-'+v.space+'"]').after(project);
                        }
                    }
                })
                layer.close(layer.open());
                if(is_in){
                    layer.msg('导入成功，部分重复项目已自动过滤');
                }else{
                    if(res.msg){
                        layer.msg('导入成功，部分项目不全，已自动删除');
                    }else{
                        layer.msg('导入成功');
                    }
                    
                }
                set_sort();
                save_order();
                initialize_datas();
                // $('#seach_datas').append(html);
            }else{
                layer.msg(res.msg);
            }
        },'json') 
    }

    function check_tmp(o){
        var tmp_id = $(o).data('tid');
        $.post('/admin/quote/ajax_get_tmp_info',{tmp_id:tmp_id},function(res){
            if(res.code == 1){
                var offerquota = res.offerquota;
                var datas = res.datas;
                var is_in = 0;
                $(res.datas).each(function(k,v){
                    if($('input[data-project="'+v.space+'-'+v.item_number+'"]').length > 0){
                        is_in = 1;
                        return true;
                    }
                    var project = '';
                    //不要工种分类
                    v.work_type = '所有工种';
                    project += '<tr class="project" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                    project += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                    project += '<td>'+v.item_number+'</td>';
                    project += '<td  class="text_left">'+offerquota[v.item_number]['project']+'</td>';
                    project += '<td><input type="text" class="layui-input height26" value="'+v.num+'" data-project="'+v.space+'-'+v.item_number+'" name="data['+v.space+']['+v.item_number+']" /></td>';
                    project += '<td>'+offerquota[v.item_number]['company']+'</td>';
                    project += '<td>'+offerquota[v.item_number]['quota']+'</td>';
                    project += '<td></td>';
                    project += '<td>'+offerquota[v.item_number]['craft_show']+'</td>';
                    project += '<td></td>';
                    project += '</tr>';
                    if($('tr[data-space="'+v.work_type+'-'+v.space+'"]').length > 0){
                        $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                    }else{
                        //空间不存在 新建空间
                        var space_html = '';
                        space_html += '<tr class="space" data-space="'+v.work_type+'-'+v.space+'" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                        space_html += '<td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td>'
                        space_html += '<td></td>'
                        space_html += '<td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">'+v.space+'</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>'
                        space_html += '<td colspan="1"></td>';
                        space_html += '<td class="space_material_total" colspan="1"></td>';
                        space_html += '<td colspan="1"></td>';
                        space_html += '<td class="space_artificial_total" colspan="1"></td>';
                        space_html += '</tr>'
                        //判断工种是否不存 
                        if($('tr[data-word="'+v.work_type+'"]').length > 0){
                            $('tr[data-inword="'+v.work_type+'"]').last().after(space_html);
                            $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                        }else{
                            //不存在 添加工种
                            var word_html = '';
                            word_html += '<tr class="word" data-word="'+v.work_type+'" data-inword="'+v.work_type+'">';
                            word_html += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                            word_html += '<td colspan="4" style="text-align: left;padding-left:10px">'+v.work_type+'</td>';
                            word_html += '<td colspan="1"></td>';
                            word_html += '<td class="word_material_total" colspan="1"></td>';
                            word_html += '<td colspan="1"></td>';
                            word_html += '<td class="word_artificial_total" colspan="1"></td>';
                            word_html += '</tr>';
                            $('#project_datas').append(word_html);
                            $('tr[data-word="'+v.work_type+'"]').after(space_html);
                            $('tr[data-space="'+v.work_type+'-'+v.space+'"]').after(project);
                        }
                    }
                })
                layer.close(layer.open());
                if(is_in){
                    layer.msg('导入成功，部分重复项目已自动过滤');
                }else{
                    if(res.msg){
                        layer.msg('导入成功，部分项目不全，已自动删除');
                    }else{
                        layer.msg('导入成功');
                    }
                    
                }
                set_sort();
                save_order();
                initialize_datas();
                // $('#seach_datas').append(html);
            }else{
                layer.msg(res.msg);
            }
        },'json') 
    }
    //=======================导入模板end

    //点击空间换颜色
    $('#diolog .left').on('click','li',function(){
        $('#diolog .left li').removeClass('checkli');
        $(this).addClass('checkli');
        $('#diolog .right li').eq(0).trigger("click");
    })

    //==============根据编号 项目名称筛选项目-start
    $('#select_item_number').on('input propertychange',function(){
        var item_number = $('#select_item_number').val();
        var project = $('#select_project').val();
        if(project || item_number){
            $('#seach_datas tr').each(function(k,v){
                if($(v).find('td').eq(1).text().indexOf(item_number) != -1 && $(v).find('td').eq(2).text().indexOf(project) != -1){
                    $(v).show();
                }else{
                    $(v).hide();
                }
            })
        }else{
            $('#seach_datas tr').show();
        }
    })

    $('#select_project').on('input propertychange',function(){
        var item_number = $('#select_item_number').val();
        var project = $('#select_project').val();
        if(project || item_number){
            $('#seach_datas tr').each(function(k,v){
                if($(v).find('td').eq(1).text().indexOf(item_number) != -1 && $(v).find('td').eq(2).text().indexOf(project) != -1){
                    $(v).show();
                }else{
                    $(v).hide();
                }
            })
        }else{
            $('#seach_datas tr').show();
        }
    })
    //清空筛选
    $('#clear_search').click(function(){
        $('#select_item_number').val('');
        $('#select_project').val('');
        $('#seach_datas tr').show();
    })
    //==============根据编号 项目名称筛选项目-end

    //选择工种 获取数据
    $('#diolog .right li').click(function(){
        if($(this).hasClass('checkli')){
            return false;
        }
        $('#diolog .right li').removeClass('checkli');
        $(this).addClass('checkli');
        var word_name = $(this).data('val');
        $('#seach_datas').html('');
        $.post('/admin/offerlist/ajax_get_project',{word_name:word_name},function(res){
            $(res.datas).each(function(k,v){
                var html = '';
                html += '<tr data-item_number="'+v.item_number+'" data-project="'+v.project+'" data-company="'+v.company+'" data-cost_value="'+v.cost_value+'" data-quota="'+v.quota+'" data-craft_show="'+v.craft_show+'" data-labor_cost="'+v.labor_cost+'" class="add_project">'
                html += '<td class="pad_0"><i class="layui-icon layui-icon-add-1"></i></td>'
                html += '<td>'+v.item_number+'</td>'
                html += '<td>'+v.project+'</td>'
                html += '</tr>'
                $('#seach_datas').append(html);
            })
        },'json')
    })

    //点击+号  向右边报价表添加数据
    $('#seach_datas').on('click',".add_project",function(){
        var space = $('#diolog .left li[class="checkli"]').text();
        // var word = $('#diolog .right li[class="checkli"]').text();
        //不要工种分类
        var word = '所有工种';
        if(!space || !word || space == '添加空间'){
            layui.use('layer', function(){
                layer.msg('工种/空间有误 请重新选择');
            }); 
            return false;
        }
        var data = $(this).data();
        //判断该项目在当前功空间和工种下 是否已经存在
        if($('input[data-project="'+space+'-'+data.item_number+'"]').length > 0){
            layui.use('layer', function(){
                layer.msg('该工种下项目已存在，请勿重复添加');
            }); 
            return false;
        }
        //加入右边报价表
        var project = '';
        project += '<tr class="project" data-inword="'+word+'" data-inspace="'+space+'">';
        project += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
        project += '<td>'+data.item_number+'</td>';
        project += '<td class="color_one text_left">'+data.project+'</td>';
        project += '<td><input type="text" class="layui-input height26" data-project="'+space+'-'+data.item_number+'" name="data['+space+']['+data.item_number+']" /></td>';
        project += '<td>'+data.company+'</td>';
        project += '<td>'+data.quota+'</td>';
        project += '<td></td>';
        project += '<td>'+data.craft_show+'</td>';
        project += '<td></td>';
        project += '</tr>';
        //选择添加的地方
        //判断当前工种下 空间是否存在
        if($('tr[data-space="'+word+'-'+space+'"]').length > 0){
            $('tr[data-inspace="'+space+'"][data-inword="'+word+'"]').last().after(project);
            var top = $('tr[data-inspace="'+space+'"][data-inword="'+word+'"]').last().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-300;
            $("#datasform_div").animate({scrollTop:top},333);
            
        }else{
            //空间不存在 新建空间
            var space_html = '';
            space_html += '<tr class="space" data-space="'+word+'-'+space+'" data-inword="'+word+'" data-inspace="'+space+'">';
            space_html += '<td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td>'
            space_html += '<td></td>'
            space_html += '<td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">'+space+'</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>'
            space_html += '<td colspan="1"></td>';
            space_html += '<td class="space_material_total" colspan="1"></td>';
            space_html += '<td colspan="1"></td>';
            space_html += '<td class="space_artificial_total" colspan="1"></td>';
            space_html += '</tr>'
            //判断工种是否不存 
            if($('tr[data-word="'+word+'"]').length > 0){
                $('tr[data-inword="'+word+'"]').last().after(space_html);
                $('tr[data-inspace="'+space+'"][data-inword="'+word+'"]').last().after(project);
                var top = $('tr[data-inspace="'+space+'"][data-inword="'+word+'"]').last().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-300;
                $("#datasform_div").animate({scrollTop:top},333);
            }else{
                //不存在 添加工种
                var word_html = '';
                word_html += '<tr class="word" data-word="'+word+'" data-inword="'+word+'">';
                word_html += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                word_html += '<td colspan="4" style="text-align: left;padding-left:10px">'+word+'</td>';
                word_html += '<td colspan="1"></td>';
                word_html += '<td class="word_material_total" colspan="1"></td>';
                word_html += '<td colspan="1"></td>';
                word_html += '<td class="word_artificial_total" colspan="1"></td>';
                word_html += '</tr>';
                $('#project_datas').append(word_html);
                $('tr[data-word="'+word+'"]').after(space_html);
                $('tr[data-space="'+word+'-'+space+'"]').after(project);
                var top = $('tr[data-inspace="'+space+'"][data-inword="'+word+'"]').last().offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop()-300;
                $("#datasform_div").animate({scrollTop:top},333);
            }
        }
        set_sort();
        save_order();//临时保存订单
    })

    //删除全部
    $('#clear_all').click(function(){
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
            content: '确认清除所有报价内容吗?',
            title:'删除确认',
            btn: ['删除', '取消'],
                yes: function(index, layero){
                    $('.space').remove();
                    $('.project').remove();
                    save_order();
                    layer.close(index);
                },
                btn2: function(index, layero){
                    layer.close(index);
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
        set_sort();
    })

    //删除报价单项目
    $('#project_datas').on('click',".layui-icon-delete",function(){
        var type = $(this).parent().parent().attr('class');
        
        if(type == 'word'){
            var msg = '确定要删除选中工种及所属项目吗？';
            var inword = $(this).parent().parent().attr('data-inword');
        }else if(type == 'space'){
            var msg = '确定要删除选中空间及所属项目吗？';
            var inspace = $(this).parent().parent().attr('data-inspace');
        }else if(type == 'project'){
            // var msg = '确定要删除选中项目吗？';
            $(this).parent().parent().remove();
            set_sort();
            initialize_datas()
            save_order();
            return false;
        }else{
            layui.use('layer', function(){
                layer.msg('非法操作');
            }); 
            return false;
        }
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
            content: msg,
            title:'删除确认',
            btn: ['删除', '取消'],
                yes: function(index, layero){
                    if(type == 'word'){
                        $('tr[data-inword="'+inword+'"]').remove();
                    }else if(type == 'space'){
                        $('tr[data-inspace="'+inspace+'"]').remove();
                    }
                    save_order();
                    set_sort();
                    initialize_datas();
                    layer.close(index);

                },
                btn2: function(index, layero){
                    layer.close(index);
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
    })
    //======================价格统计start
    var old_val = '';
    $("#project_datas").on('focus',".layui-input", function () {
        old_val = $(this).val();
    })
    $('#project_datas').on('change',".layui-input",function(){
        var num = $(this).val();
        if(num[0] === '='){
            try{
                var num = num.slice(1);
                num = num.replace('（','(');
                num = num.replace('）',')');
                num = eval(num).toFixed(1)*10/10;
                $(this).val(num);
            }catch(exception) {
                layui.use('layer', function(){
                    layer.msg('输入数量有误，请重新输入');
                }); 
                $(this).val(old_val);
                return false;
            }
        }

        if(isNaN(num)){
            layui.use('layer', function(){
                layer.msg('输入数量有误，请重新输入');
            }); 
            $(this).val(old_val);
            return false;
        }
        var tr = $(this).parent().parent();
        var artificial_price = $(tr).find('td').eq(5).text();
        var material_price = $(tr).find('td').eq(7).text();
        var project_artificial_total = artificial_price*num;
        var project_material_total = material_price*num;
        $(tr).find('td').eq(6).text(project_artificial_total.toFixed(2)); //单条项目人工总价
        $(tr).find('td').eq(8).text(project_material_total.toFixed(2)); //单条项目辅材总价
        //统计当前空间
        var space = $(tr).attr('data-inspace')
        var word = $(tr).attr('data-inword')

        var space_artificial_total = 0;
        var space_material_total = 0;
        $('#project_datas tr[data-inword="'+word+'"][data-inspace="'+space+'"][class="project"]').each(function(k,v){
            //循环当前空间内的所有项目
            space_artificial_total += Number($(v).find('td').eq(6).text());
            space_material_total += Number($(v).find('td').eq(8).text());
        })
        $('.space[data-space="'+word+'-'+space+'"]').find('td').eq(4).text(space_artificial_total.toFixed(2));
        $('.space[data-space="'+word+'-'+space+'"]').find('td').eq(6).text(space_material_total.toFixed(2));

        var word_artificial_total = 0;
        var word_material_total = 0;
        $('#project_datas tr[data-inword="'+word+'"][class="project"]').each(function(k,v){
            //循环当前工种内的所有项目
            word_artificial_total += Number($(v).find('td').eq(6).text());
            word_material_total += Number($(v).find('td').eq(8).text());
        })
        $('.word[data-word="'+word+'"]').find('td').eq(3).text(word_artificial_total.toFixed(2));
        $('.word[data-word="'+word+'"]').find('td').eq(5).text(word_material_total.toFixed(2));
        $('#g1').find('i').text((word_artificial_total+word_material_total).toFixed(2));
        save_order();
        $(this).parent().parent().find('td').eq(2).removeClass('color_one');
        // initialize_datas();
    })
    //======================价格统计end

    function initialize_datas(){
        //统计合计
        //计算单项目
        var total = 0;
        $('#project .project').each(function(k,v){
            var num = Number($(v).find('input').last().val());
            if(num == ''){
                return true;
            }
            var quota = Number($(v).find('td').eq(5).text());
            var craft_show = Number($(v).find('td').eq(7).text());
            $(v).find('td').eq(6).text((num*quota).toFixed(2));
            $(v).find('td').eq(8).text((num*craft_show).toFixed(2));
        })
        //计算空间
        $('#project .space').each(function(k,v){
            var word = $(v).data('inword');
            var space = $(v).data('inspace');
            var total_quota = 0;
            var total_craft_show = 0;
            $('.project[data-inword="'+word+'"][data-inspace="'+space+'"]').each(function(k1,v1){
                total_quota += Number($(v1).find('td').eq(6).text());
                total_craft_show += Number($(v1).find('td').eq(8).text());
            })
            $(v).find('td').eq(4).text(total_quota.toFixed(2));
            $(v).find('td').eq(6).text(total_craft_show.toFixed(2));
        })
        //计算工种
        $('#project .word').each(function(k,v){
            var word = $(v).data('inword');
            var total_quota = 0;
            var total_craft_show = 0;
            $('.space[data-inword="'+word+'"]').each(function(k1,v1){
                total_quota += Number($(v1).find('td').eq(4).text());
                total_craft_show += Number($(v1).find('td').eq(6).text());
            })
            $(v).find('td').eq(3).text(total_quota.toFixed(2));
            $(v).find('td').eq(5).text(total_craft_show.toFixed(2));
            total += total_quota;
            total += total_craft_show;
        })
        $('#g1').find('i').text(total.toFixed(2));
    }
    //排序
    function set_sort(){
        var i = 1;
        var space = '';
        var old_space = '';
        $('.project').each(function(k,v){
            old_space = $(v).attr('data-inspace');
            if(space == old_space){
                i++;
                $(v).find('.sort').val(i);
                $(v).find('.sort').attr('bj',i);
            }else{
                space = old_space;
                i = 1;
                $(v).find('.sort').val(i);
                $(v).find('.sort').attr('bj',i);
            }
        })
    }
    $(document).on('change','.sort',function(){
        var data_tr = $(this).parent().parent().parent();//获取本身的tr
        var num = $(this).val();//目标位置
        var old_num = $(this).attr('bj');//目标位置
        var space = $(data_tr).attr('data-inspace');
        var i = 0;
        $('.project[data-inspace="'+space+'"]').each(function(k,v){
            if($(v).find('.sort').val() == num){
                if(num > old_num){
                    $(data_tr).insertAfter($(v)); //将本身插入到目标tr的前面 
                }else{
                    $(data_tr).insertBefore($(v)); //将本身插入到目标tr的前面 
                }
                
            }
        })
        // var top = $("#datasform_div").scrollTop() + ($(data_tr).next().height()+$(data_tr).height())/2*num;
        var top = data_tr.offset().top - $("#datasform_div").offset().top + $("#datasform_div").scrollTop() -200;
        $("#datasform_div").animate({scrollTop:top},333);
        set_sort();
        save_order();
    })

    $(function(){

        //固定表头 start
        var seach_project_div = document.querySelector('#seach_project_div');
        var datasform_div = document.querySelector('#datasform_div');
        var left = document.querySelector('.left');
        function scrollHandle (e){
            var scrollTop = this.scrollTop;
            this.querySelector('thead').style.transform = 'translateY(' + scrollTop + 'px)';
        }
        function scrollHandleUl (e){
            var scrollTop = this.scrollTop;
            this.querySelector('#add_space').style.transform = 'translateY(' + scrollTop + 'px)';
        }
        seach_project_div.addEventListener('scroll',scrollHandle);
        datasform_div.addEventListener('scroll',scrollHandle);
        left.addEventListener('scroll',scrollHandleUl);
        //固定表头 end

        get_temporary_order()
        //判断是否有临时保存的订单
        function get_temporary_order(){
            var customerid = $('input[name="customerid"]').val();
            $.post('/admin/offerlist/get_temporary_order',{customer_id:customerid},function(res){
                if(res.code == 1){
                    var offerquota = res.offerquota;
                    var datas = res.datas;
                    var no_standard = res.no_standard;
                    var is_in = 0;
                    $(res.datas).each(function(k,v){
                        if($('input[data-project="'+v.space+'-'+v.item_number+'"]').length > 0){
                            is_in = 1;
                            return true;
                        }

                        var project = '';
                        //不要工种分类
                        v.work_type = '所有工种';
                        project += '<tr class="project" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                        if(no_standard[v.item_number]){
                            project += ' <input type="hidden" class="name" name="no_standard['+v.space+']['+v.item_number+'][name]" value="'+no_standard[v.item_number]['name']+'" />';
                            project += ' <input type="hidden" class="unit" name="no_standard['+v.space+']['+v.item_number+'][unit]" value="'+no_standard[v.item_number]['unit']+'" />';
                            project += ' <input type="hidden" class="mprice" name="no_standard['+v.space+']['+v.item_number+'][mprice]" value="'+no_standard[v.item_number]['mprice']+'" />';
                            project += ' <input type="hidden" class="aprice" name="no_standard['+v.space+']['+v.item_number+'][aprice]" value="'+no_standard[v.item_number]['aprice']+'" />';
                            project += ' <input type="hidden" class="content" name="no_standard['+v.space+']['+v.item_number+'][content]" value="'+no_standard[v.item_number]['content']+'" />';
                            project += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                            project += '<td><span style="color:red">非标</span></td>';
                            project += '<td class="text_left">'+no_standard[v.item_number]['name']+'</td>';
                            project += '<td><input type="text" class="layui-input height26" value="'+v.num+'" data-project="'+v.space+'-'+v.item_number+'" name="data['+v.space+']['+v.item_number+']" /></td>';
                            project += '<td>'+no_standard[v.item_number]['unit']+'</td>';
                            project += '<td>'+no_standard[v.item_number]['mprice']+'</td>';
                            project += '<td></td>';
                            project += '<td>'+no_standard[v.item_number]['aprice']+'</td>';
                            project += '<td></td>';
                            project += '</tr>';
                        }else{
                            project += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                            project += '<td>'+v.item_number+'</td>';
                            project += '<td>'+offerquota[v.item_number]['project']+'</td>';
                            project += '<td><input type="text" class="layui-input height26" value="'+v.num+'" data-project="'+v.space+'-'+v.item_number+'" name="data['+v.space+']['+v.item_number+']" /></td>';
                            project += '<td>'+offerquota[v.item_number]['company']+'</td>';
                            project += '<td>'+offerquota[v.item_number]['quota']+'</td>';
                            project += '<td></td>';
                            project += '<td>'+offerquota[v.item_number]['craft_show']+'</td>';
                            project += '<td></td>';
                            project += '</tr>';
                        }
                        

                        if($('tr[data-space="'+v.work_type+'-'+v.space+'"]').length > 0){
                        $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                        }else{
                            //空间不存在 新建空间
                            var space_html = '';
                            space_html += '<tr class="space" data-space="'+v.work_type+'-'+v.space+'" data-inword="'+v.work_type+'" data-inspace="'+v.space+'">';
                            space_html += '<td><i class="layui-icon layui-icon-delete"></i><span class="layui-table-sort layui-inline"><i class="layui-edge layui-table-sort-asc" title="向上移动"></i><i class="layui-edge layui-table-sort-desc" title="向下移动"></i></span></td>'
                            space_html += '<td></td>'
                            space_html += '<td colspan="3" style="text-align: left;padding-left:10px"><span class="space_name">'+v.space+'</span><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs copy">复制</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs no_standard">添加非标</a><a href="javascript:;" style="margin-left:10px" class="layui-btn layui-btn-primary layui-btn-xs replace_space">更换空间</a></td>'
                            space_html += '<td colspan="1"></td>';
                            space_html += '<td class="space_material_total" colspan="1"></td>';
                            space_html += '<td colspan="1"></td>';
                            space_html += '<td class="space_artificial_total" colspan="1"></td>';
                            space_html += '</tr>'
                            //判断工种是否不存 
                            if($('tr[data-word="'+v.work_type+'"]').length > 0){
                                $('tr[data-inword="'+v.work_type+'"]').last().after(space_html);
                                $('tr[data-inspace="'+v.space+'"][data-inword="'+v.work_type+'"]').last().after(project);
                            }else{
                                //不存在 添加工种
                                var word_html = '';
                                word_html += '<tr class="word" data-word="'+v.work_type+'" data-inword="'+v.work_type+'">';
                                word_html += '<td><i class="layui-icon layui-icon-delete"></i><span class=""><input class="sort" type="text" /></span></td>';
                                word_html += '<td colspan="4" style="text-align: left;padding-left:10px">'+v.work_type+'</td>';
                                word_html += '<td colspan="1"></td>';
                                word_html += '<td class="word_material_total" colspan="1"></td>';
                                word_html += '<td colspan="1"></td>';
                                word_html += '<td class="word_artificial_total" colspan="1"></td>';
                                word_html += '</tr>';
                                $('#project_datas').append(word_html);
                                $('tr[data-word="'+v.work_type+'"]').after(space_html);
                                $('tr[data-space="'+v.work_type+'-'+v.space+'"]').after(project);
                            }
                        }
                    })
                    set_sort();
                    initialize_datas();
                }else{
                    set_sort();
                    initialize_datas();
                    console.log('no temporary order');
                }
            },'json') 
        }
    })
    $('#sel').on('input propertychange','',function(){
        var item= $('#sel').val();
        if(item!=''){
            $("#space_ul li").each(function (index,element ) {
                if($(this).text().indexOf(item) != -1){
                    $(this).show();
                }else {
                    $(this).hide();
                }
            })
        }else {
            $("#space_ul li").show();
        }
    })
    $(document).on('click','input',function(){
        $(this).select();
    })
    $(document).on('click','.space_name',function(){
        var space_name = $(this).text();
        $('#space_ul li').each(function(k,v){
            if($(v).text() == space_name){
                $('#space_ul li[data-val="'+space_name+'"]').trigger("click");
            }
        })
    })
    //监听键盘
    $(document).on('keydown','.project input',function(event){
        if(event.keyCode == 13 || event.keyCode == 40 ){
            console.log(event.keyCode);
            var tr = $(this).parent().parent().nextAll('.project').eq(0).find('input').not('.sort').not('.no_standard').select();
            return false;
        }
        if(event.keyCode == 38 ){
            var tr = $(this).parent().parent().prevAll('.project').eq(0).find('input').not('.sort').not('.no_standard').select();
            return false;
        }
    })
    //设置费率
    $('#set_tmp_cost').click(function(){
        $.post('/admin/quote/get_tmp_cost_list',{},function(res){
            if(res.code == 1){
                
            }else{
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg(res.msg);
                });  
            }
        },'json')
    })
    //监控窗口宽度变化
    $(window).resize(function(){
        if( $(window).width() <= 1150 ) {
            $('body').css('cssText','font-size : 12px !important');
            $('.layui-table td, .layui-table th').css('cssText','font-size : 12px !important');
        }else{
            $('body').css('cssText','font-size : 14px !important');
            $('.layui-table td, .layui-table th').css('cssText','font-size : 14px !important');
        }
    });
</script>
{/block}