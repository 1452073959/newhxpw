{extend name="index_layout"/}
{block name="main"}
<style type="text/css">
    .tmp_datas{
        background-color: #ffffff;
        padding-top:20px;
    }
    .w600{
        width: 600px;
    }
    .discount_table th ,.discount_table td{
        text-align: center !important;
    }
    .tmp_datas{
        background-color: #ffffff;
        padding-top:20px;
        height:600px;
    }
    .mt30{
        margin-left: 30px;
    }
    .m30{
        margin: 30px;
    }
    .discout_table{
        width: 80%;
    }
    .w50{
        width: 60px !important;
        height: 28px;
        line-height: 28px;
        float: left;
        padding: 9px 3px;
    }
    .div_right{
        margin-left: 65px;
        padding: 9px 5px;
    }
    .div_right ul{
        display: inline-block;
        width: 100%;
        /*height:100px;*/
    }
    .div_right ul li{
        /*display: flex;*/
        float: left;
        min-width: 30px;
        height:26px;
        line-height: 26px;
        text-align: center;
        border:1px solid #999;
        margin-left: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        padding: 0 10px;
    }
    .div_right ul li:hover{
        color:#333;
    }
    .prew li{
        margin:0 !important;
        margin-left: 10px !important; 
        position: relative;
        cursor:default !important; 
    }
    .prew li i{
        position: absolute;
        top:-7px;
        right:0;
        font-style: normal;
        cursor: pointer;
        font-size: 10px;
    }

    .w250{
        width: 250px !important;
    }
    .childrenBody{
        background-color: #ffffff;
    }
</style>
<link rel="stylesheet" type="text/css" href="https://www.layuicdn.com/layui/css/layui.css" />
<form class="layui-form" action="">
<div class="tmp_datas">
    <input type="hidden" name="f_id" value="{$f_id}">
    <div class="layui-form-item">
        <label class="layui-form-label w150">优惠设置</label>

        <div class="layui-input-inline w600">
            <table class="layui-table discount_table">
                <colgroup>
                    <col width="100">
                    <col width="120">
                    <col width="200">
                    <col width="60">
                </colgroup>
                <thead>
                    <tr>
                        <th>优惠名称</th>
                        <th>公式</th>
                        <th>说明</th>
                        <th><a href="javascript:;" class="add_discount"><i class="layui-icon layui-icon-add-1"></i></a></th>
                    </tr>
                </thead>
                <tbody>
                    {foreach $discount as $k=>$v}
                        <tr>
                            <td>{$v['name']}</td>
                            <td>{$v['formula']}</td>
                            <td>{$v['content']}</td>
                            <td><a href="javascript:;" class="del_discount" data-did="{$v['id']}"><i class="layui-icon layui-icon-delete"></i></a></td>
                        </tr>
                    {/foreach}
                </tbody>
            </table>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label w150">监理提成*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="supervisor" autocomplete="off" value="{$data.supervisor}" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label w150">设计提成*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="design" autocomplete="off" value="{$data.design}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">回头客提成*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="repeat" autocomplete="off" value="{$data.repeat}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">业务提成*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="business" autocomplete="off" value="{$data.business}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">订单底部文字*<p></p></label>
        <div class="layui-input-inline w150">
            <textarea name="order_tfoot" style="height:300px;width:550px">{$data.order_tfoot}</textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">一期款收费比率*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="take_rate1" autocomplete="off" value="{$data.take_rate1}" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label w150">二期款收费比率*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="take_rate2" autocomplete="off" value="{$data.take_rate2}" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label w150">三期款收费比率*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="take_rate3" autocomplete="off" value="{$data.take_rate3}" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label w150">四期款收费比率*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="take_rate4" autocomplete="off" value="{$data.take_rate4}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">领料审核界限*（%）</label>
        <div class="layui-input-inline w150">
            <input type="text" name="pick_rate" autocomplete="off" value="{$data.pick_rate}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">监理借支比率*（%）</label>
        <div class="layui-input-inline w150">
            <input type="number" name="borrower" autocomplete="off" value="{$data.borrower}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label w150">报价模式</label>
        <div class="layui-input-inline w150" >
            <li> <input type="radio" name="type" value="2" {if ($data.type==2)} checked {/if} title="综合价"></li>
            <li> <input type="radio" name="type" value="1" {if ($data.type==1)} checked {/if} title="辅材费/人工费"></li>
        </div>
    </div>
   <!--  <div class="layui-form-item">
        <label class="layui-form-label w150">质检流程*<p>（每行一条，名称与说明使用"-"分开，名称必须为工种前两个字）</p></label>
        <div class="layui-input-inline w150">
            <textarea placeholder="例子：&#13;&#10;打拆-打拆工程具体流程说明&#13;&#10;木工-木工工程具体流程说明&#13;&#10;泥瓦-泥瓦工程具体流程说明" name="order_check" style="height:300px;width:550px">{$data.order_check}</textarea>
        </div>
    </div> -->

    <div class="layui-input-inline w300">
        <button id="edit_tmp" style="margin-left:70px" class="layui-btn ajax-post">立即提交</button>
    </div>
    <div class="layui-input-inline w300">
        
    </div>
</div>
</form>
{/block}
{block name="script"}
<script type="text/javascript" src="__STATIC__/admin/js/common.js"></script>
<script src="/static/admin/js/jquery.min.js"></script>
<script type="text/javascript">
    $(document).on('click','.click_ul li',function(){
        var val = $(this).text();
        var html = '<li><span>'+val+'</span><i class="close_li">×</i></li>';
        $('.prew').append(html);
    })
    $(document).on('click','.prew .close_li',function(){
        $(this).parent().remove();
    })
    $('.del_discount').click(function(){
        var did = $(this).attr('data-did');
        var that = this;
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                content: '是否确定删除选中优惠？',
                title:'删除优惠',
                btn: ['确认','取消'],
                yes: function(index, layero){
                    
                    $.post('/admin/discount/del_discount',{did:did},function(res){
                        if(res.code == 1){
                            layer.msg('删除成功');
                            $(that).parent().parent().remove();
                        }else{
                            layer.msg(res.msg);
                        }
                    },'json')

                    // return false;
                },
                cancel: function(){ 
                //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }); 
    })
    $('.add_discount').click(function(){
        $.post('/admin/discount/get_discount_list',{fid:0},function(res){
            var html = '';
            html += '<div class="layui-tab">'
            html += '   <ul class="layui-tab-title">'
            html += '       <li class="layui-this">自定义优惠</li>'
            html += '       <li>选择优惠</li>'
            html += '   </ul>'
            html += '   <div class="layui-tab-content">'
            html += '       <div class="layui-tab-item layui-show">'
            html += '           <div class="layui-form-item">'
            html += '               <label class="w50">字段</label>'
            html += '               <div class="div_right">'
            html += '                   <ul class="click_ul">'
            html += '                       <li>工程直接费</li>'
            html += '                       <li>材料直接费</li>'
            html += '                       <li>人工直接费</li>'
            html += '                       <li>工程报价</li>'
            html += '                       <li>纯人工项目</li>'
            html += '                       <li>特价项目</li>'
            html += '                       <li>设计费</li>'
            html += '                       <li>打拆工程</li>'
            html += '                       <li>电工工程</li>'
            html += '                       <li>加建工程</li>'
            html += '                       <li>镜钢玻璃类</li>'
            html += '                       <li>木工工程</li>'
            html += '                       <li>泥瓦工程</li>'
            html += '                       <li>水工工程</li>'
            html += '                       <li>油灰工程</li>'
            html += '                       <li>综合类</li>'
            html += '                       <li>现金</li>'
            html += '                   </ul>'
            html += '               </div>'
            html += '           </div>'
            html += '           <div class="layui-form-item">'
            html += '               <label class="w50">字段</label>'
            html += '               <div class="div_right">'
            html += '                   <ul class="click_ul">'
            html += '                       <li>+</li>'
            html += '                       <li>-</li>'
            html += '                       <li>×</li>'
            html += '                       <li>÷</li>'
            html += '                       <li>(</li>'
            html += '                       <li>)</li>'
            html += '                   </ul>'
            html += '               </div>'
            html += '           </div>'
            html += '           <div class="layui-form-item">'
            html += '               <label class="w50">预览</label>'
            html += '               <div class="div_right" style="border:1px solid #c9c9c9;padding:3px 5px;height:28px">'
            html += '                   <ul class="prew">'
            html += '                   </ul>'
            html += '               </div>'
            html += '           </div>'
            html += '           <div class="layui-form-item">'
            html += '               <label class="w50">优惠名称</label>'
            html += '               <div class="div_right">'
            html += '                   <input class="layui-input w250" name="discount_name" />'
            html += '               </div>'
            html += '           </div>'
            html += '           <div class="layui-form-item">'
            html += '               <label class="w50">优惠说明</label>'
            html += '               <div class="div_right">'
            html += '                   <input class="layui-input " name="discount_content" />'
            html += '               </div>'
            html += '           </div>'
            html += '       </div>'
            html += '       <div class="layui-tab-item">'
            html += '           <div class="layui-input-inline w600">'
            html += '               <table class="layui-table discount_table">'
            html += '                   <colgroup>'
            html += '                       <col width="60">'
            html += '                       <col width="100">'
            html += '                       <col width="120">'
            html += '                       <col width="150">'
            html += '                   </colgroup>'
            html += '                   <thead>'
            html += '                       <tr>'
            html += '                           <th>操作</th>'
            html += '                           <th>优惠名称</th>'
            html += '                           <th>公式</th>'
            html += '                           <th>说明<a href="javascript:;" class="add_discount"></th>'
            html += '                       </tr>'
            html += '                   </thead>'
            html += '                   <tbody>'
            $.each(res.data, function (k, v) {
                html += '                       <tr>'
                html += '                           <td><a href="javascript:;" data-id="'+v.id+'" class="add_discount_by_basis"><i class="layui-icon layui-icon-add-1"></i></a></td>'
                html += '                           <td>'+v.name+'</td>'
                html += '                           <td>'+v.formula+'</td>'
                html += '                           <td>'+v.content+'</td>'
                html += '                       </tr>'
            })
            html += '                   </tbody>'
            html += '               </table>'
            html += '           </div>'
            html += '       </div>'
            html += '   </div>'
            html += '</div>'
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.open({
                    content: html,
                    area: ['60%', '60%'],
                    title:'添加优惠',
                    btn: ['确认','取消'],
                    yes: function(index, layero){
                        var discount_name = $('input[name="discount_name"]').val();
                        var discount_content = $('input[name="discount_content"]').val();
                        var discount_val = '';
                        $('.prew').find('li').each(function(k,v){
                            discount_val += $(v).find('span').text();
                        })
                        $.post('/admin/discount/add_basis_discount',{discount_val:discount_val,discount_name:discount_name,discount_content:discount_content,fid:$('input[name="f_id"]').val()},function(res){
                            if(res.code == 1){
                                layer.msg('添加成功');
                                setTimeout(function () {
                                    window.location.reload();
                                }, 1000);
                            }else{
                                alert(res.msg);
                            }
                        },'json')

                        return false;
                    },
                    cancel: function(){ 
                    //return false 开启该代码可禁止点击该按钮关闭
                    }
                });
            }); 
        },'json')
        
    })
    $(document).on('click','.add_discount_by_basis',function(){
        var did = $(this).attr('data-id');
        $.post('/admin/discount/add_discount_by_basis',{did:did},function(res){
            if(res.code == 1){
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.msg('添加成功');
                })
                setTimeout(function () {
                    window.location.reload();
                }, 1000);
            }else{
                alert(res.msg);
            }
        },'json')
    })
    $("#edit_tmp").click(function() {
        var fid = $('input[name="f_id"]').val();
        var supervisor = $(this).parents(".tmp_datas").find("input[name='supervisor']").val();
        var design = $(this).parents(".tmp_datas").find("input[name='design']").val();
        var repeat = $(this).parents(".tmp_datas").find("input[name='repeat']").val();
        var business = $(this).parents(".tmp_datas").find("input[name='business']").val();
        var order_tfoot = $(this).parents(".tmp_datas").find("textarea[name='order_tfoot']").val();

        var take_rate1 = $(this).parents(".tmp_datas").find("input[name='take_rate1']").val();
        var take_rate2 = $(this).parents(".tmp_datas").find("input[name='take_rate2']").val();
        var take_rate3 = $(this).parents(".tmp_datas").find("input[name='take_rate3']").val();
        var take_rate4 = $(this).parents(".tmp_datas").find("input[name='take_rate4']").val();

        var pick_rate = $(this).parents(".tmp_datas").find("input[name='pick_rate']").val();
        // var order_check = $(this).parents(".tmp_datas").find("textarea[name='order_check']").val();
        var borrower = $(this).parents(".tmp_datas").find("input[name='borrower']").val();
        var type =$('input:radio:checked').val();
        if(Number(take_rate1) + Number(take_rate2) + Number(take_rate3) + Number(take_rate4) != 100 ){
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('收款比率合计必须为100');
            });
            return false;
        }
        if (!supervisor || isNaN(supervisor)) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('监理提成输入有误');
            });
            return false;
        }
        if (!design || isNaN(design)) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('设计提成输入有误');
            });
            return false;
        }
        if (!repeat || isNaN(repeat)) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('回头客提成输入有误');
            });
            return false;
        }
        if (!business || isNaN(business)) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('业务提成输入有误');
            });
            return false;
        }
        if (parseFloat(supervisor)+parseFloat(design)+parseFloat(repeat)+parseFloat(business) > 100) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('全部合计不得超过100');
            });
            return false;
        }
        if (!pick_rate || isNaN(pick_rate)) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('领料审核界限输入有误');
            });
            return false;
        }
        // if (!order_check) {
        //     layui.use('layer', function(){
        //         var layer = layui.layer;
        //         layer.msg('质检流程不能为空');
        //     });
        //     return false;
        // }
        $.ajax({
            type : 'post',
            url  :  '{:url("indent/edit_tmp")}',
            dataType : 'json',
            data : {
                f_id:fid,
                order_tfoot:order_tfoot,
                supervisor:supervisor,
                design:design,
                repeat:repeat,
                business:business,
                take_rate1:take_rate1,
                take_rate2:take_rate2,
                take_rate3:take_rate3,
                take_rate4:take_rate4,
                pick_rate:pick_rate,
                // order_check:order_check,
                borrower:borrower,
                type:type,
            },
            success : function(re){
              if(re.status == 0){
                    layui.use('layer', function(){
                        var layer = layui.layer;
                        layer.msg(re.msg);
                    });
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                    return false;
              }else{
                layui.use('layer', function(){
                        var layer = layui.layer;
                        layer.msg(re.msg);
                    });
                return false;
              }
            }
        });
    });
</script>


{/block}